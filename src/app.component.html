@if (!authService.isLoggedIn()) {
  <app-login (login)="onLogin($event)" [error]="loginError()" />
} @else {
  @if (!dataService.isDataLoaded()) {
    <div class="flex h-screen w-full flex-col items-center justify-center bg-gray-50 dark:bg-zinc-900 text-zinc-600 dark:text-zinc-400">
      <svg class="animate-spin h-10 w-10 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-4 text-lg font-semibold">Cargando datos de la aplicación...</p>
      <p class="mt-1 text-sm">Por favor, espera un momento.</p>
    </div>
  } @else {
    <div class="flex h-screen bg-gray-50 dark:bg-zinc-900 text-zinc-800 dark:text-zinc-200">
    
      <!-- Overlay for mobile when sidebar is open -->
      @if (isSidebarOpen()) {
        <div (click)="isSidebarOpen.set(false)" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>
      }

      <!-- Sidebar -->
      <aside 
        class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-zinc-800 shadow-xl transform transition-transform duration-300 ease-in-out z-30 md:relative md:translate-x-0"
        [class.translate-x-0]="isSidebarOpen()"
        [class.-translate-x-full]="!isSidebarOpen()">
        
        <div class="p-4 border-b border-gray-200 dark:border-zinc-700 flex items-center gap-3">
          <svg class="w-8 h-8 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
          </svg>
          <h1 class="text-xl font-bold text-zinc-800 dark:text-white">HouseHold Hub</h1>
        </div>

        <nav class="p-4">
          <ul>
            <li>
              <a (click)="setActiveView('dashboard')"
                class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                [class.bg-sky-100]="activeView() === 'dashboard'"
                [class.dark:bg-sky-900]="activeView() === 'dashboard'"
                [class.text-sky-600]="activeView() === 'dashboard'"
                [class.dark:text-sky-300]="activeView() === 'dashboard'"
                [class.hover:bg-gray-100]="activeView() !== 'dashboard'"
                [class.dark:hover:bg-zinc-700]="activeView() !== 'dashboard'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span>Resumen</span>
              </a>
            </li>
            <li class="mt-2">
              <a (click)="setActiveView('gastos')"
                class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                [class.bg-sky-100]="activeView() === 'gastos'"
                [class.dark:bg-sky-900]="activeView() === 'gastos'"
                [class.text-sky-600]="activeView() === 'gastos'"
                [class.dark:text-sky-300]="activeView() === 'gastos'"
                [class.hover:bg-gray-100]="activeView() !== 'gastos'"
                [class.dark:hover:bg-zinc-700]="activeView() !== 'gastos'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-1.134 0V7.418zM12.75 7.151c.22.07.409.164.567.267v-1.698a2.5 2.5 0 00-1.134 0v1.698zM11.5 6.25a.75.75 0 00-1.5 0v1.134a2.5 2.5 0 001.5 0V6.25z" /><path fill-rule="evenodd" d="M3.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h12.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75H3.75zM8.5 7a2.5 2.5 0 00-2.5 2.5v.75a.75.75 0 001.5 0v-.75a1 1 0 011-1h3a1 1 0 011 1v.75a.75.75 0 001.5 0v-.75a2.5 2.5 0 00-2.5-2.5h-3zM14 12.75a.75.75 0 00-.75-.75H6.75a.75.75 0 000 1.5h6.5a.75.75 0 00.75-.75z" clip-rule="evenodd" /></svg>
                <span>Gastos</span>
              </a>
            </li>
            <li class="mt-2">
              <a (click)="setActiveView('suscripciones')"
                class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                [class.bg-sky-100]="activeView() === 'suscripciones'"
                [class.dark:bg-sky-900]="activeView() === 'suscripciones'"
                [class.text-sky-600]="activeView() === 'suscripciones'"
                [class.dark:text-sky-300]="activeView() === 'suscripciones'"
                [class.hover:bg-gray-100]="activeView() !== 'suscripciones'"
                [class.dark:hover:bg-zinc-700]="activeView() !== 'suscripciones'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691v4.992h-4.992m0 0-3.181-3.183a8.25 8.25 0 0 1 11.667 0l3.181 3.183" />
                </svg>
                <span>Suscripciones</span>
              </a>
            </li>
            <li class="mt-2">
              <a (click)="setActiveView('notas')"
                class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                [class.bg-sky-100]="activeView() === 'notas'"
                [class.dark:bg-sky-900]="activeView() === 'notas'"
                [class.text-sky-600]="activeView() === 'notas'"
                [class.dark:text-sky-300]="activeView() === 'notas'"
                [class.hover:bg-gray-100]="activeView() !== 'notas'"
                [class.dark:hover:bg-zinc-700]="activeView() !== 'notas'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2-2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                <span>Notas</span>
              </a>
            </li>
            <li class="mt-2">
              <a (click)="setActiveView('metricas')"
                class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                [class.bg-sky-100]="activeView() === 'metricas'"
                [class.dark:bg-sky-900]="activeView() === 'metricas'"
                [class.text-sky-600]="activeView() === 'metricas'"
                [class.dark:text-sky-300]="activeView() === 'metricas'"
                [class.hover:bg-gray-100]="activeView() !== 'metricas'"
                [class.dark:hover:bg-zinc-700]="activeView() !== 'metricas'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                </svg>
                <span>Métricas</span>
              </a>
            </li>
            <li class="mt-2 border-t border-gray-200 dark:border-zinc-700 pt-2"></li>
            @if (authService.isAdmin()) {
              <li class="mt-2">
                <a (click)="setActiveView('casas')"
                  class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                  [class.bg-sky-100]="activeView() === 'casas'"
                  [class.dark:bg-sky-900]="activeView() === 'casas'"
                  [class.text-sky-600]="activeView() === 'casas'"
                  [class.dark:text-sky-300]="activeView() === 'casas'"
                  [class.hover:bg-gray-100]="activeView() !== 'casas'"
                  [class.dark:hover:bg-zinc-700]="activeView() !== 'casas'">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5-1.5-.545M3 7.5l3 1.5M3 7.5l-1.5-1.5M4.5 12l-3 1.5m15-3l3-1.5m-6-6l-1.5 1.5" />
                  </svg>
                  <span>Casas</span>
                </a>
              </li>
              <li class="mt-2">
                <a (click)="setActiveView('usuarios')"
                  class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                  [class.bg-sky-100]="activeView() === 'usuarios'"
                  [class.dark:bg-sky-900]="activeView() === 'usuarios'"
                  [class.text-sky-600]="activeView() === 'usuarios'"
                  [class.dark:text-sky-300]="activeView() === 'usuarios'"
                  [class.hover:bg-gray-100]="activeView() !== 'usuarios'"
                  [class.dark:hover:bg-zinc-700]="activeView() !== 'usuarios'">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-2.253 9.527 9.527 0 0 0-2.253-4.121m-4.5-4.5L9 10.5m-3 3L3 16.5m-3-3l3.375-3.375a9.375 9.375 0 0 1 13.257 0c3.686 3.686 3.686 9.574 0 13.26-3.686 3.687-9.574 3.687-13.26 0L3 16.5m9-9c.59 0 1.154.12 1.682.336" />
                  </svg>
                  <span>Usuarios</span>
                </a>
              </li>
              <li class="mt-2">
                <a (click)="setActiveView('configuracion')"
                  class="flex items-center gap-3 px-3 py-2 rounded-md cursor-pointer transition-colors"
                  [class.bg-sky-100]="activeView() === 'configuracion'"
                  [class.dark:bg-sky-900]="activeView() === 'configuracion'"
                  [class.text-sky-600]="activeView() === 'configuracion'"
                  [class.dark:text-sky-300]="activeView() === 'configuracion'"
                  [class.hover:bg-gray-100]="activeView() !== 'configuracion'"
                  [class.dark:hover:bg-zinc-700]="activeView() !== 'configuracion'">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-.952l2.715.345a1.125 1.125 0 0 1 .971.971l.345 2.715c.054.424-.225.84-.675.972l-2.716.422a1.125 1.125 0 0 1-1.258-.468l-1.14-2.28a1.125 1.125 0 0 1 .19-1.285zM12 8.25a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12.991 14.85c-.324.232-.69.413-1.093.535l-2.715.422a1.125 1.125 0 0 1-1.258-.468l-1.14-2.28a1.125 1.125 0 0 1 .19-1.285l2.28-1.14a1.125 1.125 0 0 1 1.258.468l.422 2.715c.123.403.294.77.535 1.093m0 0a2.472 2.472 0 0 1 .535 1.093l.422 2.715a1.125 1.125 0 0 1-.468 1.258l-2.28 1.14a1.125 1.125 0 0 1-1.285-.19l-2.715-.422a1.125 1.125 0 0 1-.972-.675l-1.14-2.28a1.125 1.125 0 0 1 .468-1.258l2.715-.422a2.472 2.472 0 0 1 1.093-.535m0 0a4.47 4.47 0 0 0 3.82-1.954 4.47 4.47 0 0 0-3.82-1.954A4.47 4.47 0 0 0 8.17 8.17a4.47 4.47 0 0 0 1.954 3.82m3.82 0a4.47 4.47 0 0 0 1.954-3.82 4.47 4.47 0 0 0-1.954-3.82" />
                  </svg>
                  <span>Configuración</span>
                </a>
              </li>
            }
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        
        <header class="bg-white dark:bg-zinc-800 shadow-md p-4 flex items-center shrink-0">
          <button (click)="isSidebarOpen.set(!isSidebarOpen())" class="text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 focus:outline-none md:hidden">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
          </button>
          
          <div class="ml-4 md:ml-0 text-zinc-600 dark:text-zinc-300">
            Hola, <span class="font-semibold">{{ authService.currentUser()?.username }}</span>
          </div>

          <div class="ml-auto flex items-center gap-4">
            @if (visibleHouses().length > 1 && activeView() !== 'metricas' && activeView() !== 'suscripciones' && activeView() !== 'usuarios' && activeView() !== 'configuracion') {
              <div class="relative">
                <select (change)="onHouseSelect($event)" class="text-base appearance-none block w-full md:w-64 bg-white dark:bg-zinc-700 border border-gray-300 dark:border-zinc-600 hover:border-gray-400 px-4 py-2.5 pr-8 rounded-md shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                  @for (house of visibleHouses(); track house.id) {
                    <option [value]="house.id" [selected]="house.id === selectedHouse()?.id">{{ house.name }}</option>
                  }
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-zinc-700 dark:text-zinc-300">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
              </div>
            }

            @if (currencies().length > 1 && displayCurrency(); as dc) {
              <div class="relative">
                <select (change)="onDisplayCurrencyChange($event)" class="text-base appearance-none block w-full md:w-40 bg-white dark:bg-zinc-700 border border-gray-300 dark:border-zinc-600 hover:border-gray-400 px-4 py-2.5 pr-8 rounded-md shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                  @for (currency of currencies(); track currency.code) {
                    <option [value]="currency.code" [selected]="currency.code === dc.code">{{ currency.code }} - {{ currency.symbol }}</option>
                  }
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-zinc-700 dark:text-zinc-300">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
              </div>
            }
            
            <button (click)="logout()" title="Cerrar sesión" class="flex items-center justify-center w-10 h-10 rounded-full text-zinc-500 dark:text-zinc-400 hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-zinc-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
              </svg>
            </button>

            <button (click)="toggleTheme()" title="Cambiar tema"
                class="flex items-center justify-center w-10 h-10 rounded-full text-zinc-500 dark:text-zinc-400 hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-zinc-800">
                @if (theme() === 'dark') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                }
            </button>
          </div>

        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-8 relative">
          
          @switch (activeView()) {
            @case ('dashboard') {
              @if (selectedHouse(); as house) {
                <div class="max-w-7xl mx-auto">
                  <div class="mb-6">
                      <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Resumen de {{ house.name }}</h2>
                      <p class="text-zinc-500 dark:text-zinc-400 mt-1">{{ currentDateDisplay }}</p>
                  </div>

                  <!-- Stats Grid -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Total Pendiente</p>
                            <p class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">
                                {{ formatCompactCurrency(totalPendingAmount()) }}
                            </p>
                        </div>
                        <div class="bg-red-100 dark:bg-red-900/50 p-3 rounded-full">
                            <svg class="w-6 h-6 text-red-500 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Gastos Pendientes</p>
                            <p class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">{{ pendingExpensesCount() }}</p>
                        </div>
                        <div class="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-full">
                            <svg class="w-6 h-6 text-yellow-500 dark:text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>
                        </div>
                    </div>
                     <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Pagado este Mes</p>
                            <p class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">
                              {{ formatCompactCurrency(totalPaidThisMonth()) }}
                            </p>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-full">
                           <svg class="w-6 h-6 text-green-500 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Vence esta Semana</p>
                            <p class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">{{ dueThisWeekCount() }}</p>
                        </div>
                        <div class="bg-sky-100 dark:bg-sky-900/50 p-3 rounded-full">
                            <svg class="w-6 h-6 text-sky-500 dark:text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M-4.5 12h22.5" /></svg>
                        </div>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Upcoming Dues & Pinned Notes -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- Upcoming Dues -->
                        <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Próximos Vencimientos</h3>
                            <div class="space-y-4 max-h-64 overflow-y-auto pr-2">
                                @for(expense of pendingExpenses().slice(0, 5); track expense.id) {
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-zinc-800 dark:text-zinc-200">{{ expense.description }}</p>
                                            <p class="text-sm text-zinc-500 dark:text-zinc-400">{{ expense.dueDate | date:'d MMMM' }}</p>
                                        </div>
                                        <p class="font-bold text-zinc-900 dark:text-white">
                                            {{ currencyService.convert(expense.amount, expense.currency, displayCurrency()!.code) | number:'1.2-2' }} {{ displayCurrency()?.symbol }}
                                        </p>
                                    </div>
                                } @empty {
                                  <div class="text-center py-8">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white">Todo al día</h3>
                                    <p class="mt-1 text-sm text-gray-500 dark:text-zinc-400">No hay gastos pendientes.</p>
                                  </div>
                                }
                            </div>
                        </div>

                        <!-- Pinned Notes -->
                        <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Notas Ancladas</h3>
                            <div class="space-y-4 max-h-64 overflow-y-auto pr-2">
                                @for(note of pinnedNotesForSelectedHouse(); track note.id) {
                                    <div class="border-l-4 border-amber-400 pl-4">
                                        <p class="font-semibold text-zinc-800 dark:text-zinc-200">{{ note.title }}</p>
                                        <p class="text-sm text-zinc-500 dark:text-zinc-400 whitespace-pre-wrap">{{ note.content }}</p>
                                    </div>
                                } @empty {
                                  <div class="text-center py-8">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                                    <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white">Sin notas ancladas</h3>
                                    <p class="mt-1 text-sm text-gray-500 dark:text-zinc-400">Ancla una nota para verla aquí.</p>
                                  </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Expenses by Category Chart -->
                    <div class="lg:col-span-2 bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Gastos por Categoría</h3>
                        @if (expensesByCategory().length > 0) {
                          <app-category-chart [data]="expensesByCategory()" [currency]="displayCurrency()?.code ?? 'CUP'" />
                        } @else {
                          <div class="flex items-center justify-center h-full min-h-[300px]">
                            <p class="text-zinc-500 dark:text-zinc-400">No hay datos de gastos para mostrar.</p>
                          </div>
                        }
                    </div>
                  </div>
                </div>
              } @else {
                <div class="text-center py-20">
                  <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5-1.5-.545M3 7.5l3 1.5M3 7.5l-1.5-1.5M4.5 12l-3 1.5m15-3l3-1.5m-6-6l-1.5 1.5" /></svg>
                  <h2 class="mt-2 text-2xl font-semibold">No hay casas disponibles</h2>
                  @if (authService.isAdmin()) {
                    <p class="text-zinc-500 dark:text-zinc-400 mt-2">Por favor, añade una casa en la sección 'Casas' para empezar.</p>
                    <button (click)="setActiveView('casas')" class="mt-4 flex mx-auto items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                      Ir a Casas
                    </button>
                  } @else {
                     <p class="text-zinc-500 dark:text-zinc-400 mt-2">No tienes ninguna casa asignada. Contacta a un administrador.</p>
                  }
                </div>
              }
            }
            @case ('gastos') {
              @if (selectedHouse(); as house) {
                <div class="max-w-7xl mx-auto">
                  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Gastos de {{ house.name }}</h2>
                    <button (click)="openExpenseForm()" class="mt-4 sm:mt-0 flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span>Añadir Gasto</span>
                    </button>
                  </div>
                  <!-- Filters and View Toggles -->
                  <div class="mb-6 bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md">
                      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
                          <select (change)="onCategoryFilterChange($event)" [value]="categoryFilter()" class="w-full text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                              <option value="all">Todas las Categorías</option>
                              @for (cat of expenseCategories(); track cat) {
                                  <option [value]="cat">{{ cat }}</option>
                              }
                          </select>
                          <select (change)="onStatusFilterChange($event)" [value]="statusFilter()" class="w-full text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                              <option value="all">Todos los Estados</option>
                              <option value="PENDING">Pendiente</option>
                              <option value="COMPLETED">Completado</option>
                          </select>
                          <select (change)="onMonthFilterChange($event)" [value]="monthFilter()" class="w-full text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                              <option value="all">Todos los Meses</option>
                              @for (month of monthOptions; track month.value) {
                                  <option [value]="month.value">{{ month.label }}</option>
                              }
                          </select>
                          <input type="date" (change)="onDateFilterChange($event, 'from')" [value]="dateFromFilter() || ''" class="w-full text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                          <input type="date" (change)="onDateFilterChange($event, 'to')" [value]="dateToFilter() || ''" class="w-full text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                          <button (click)="resetFilters()" class="w-full px-4 py-2 text-sm font-medium text-zinc-700 dark:text-zinc-200 bg-gray-100 dark:bg-zinc-600 rounded-md hover:bg-gray-200 dark:hover:bg-zinc-500">
                              Restablecer
                          </button>
                      </div>
                      <div class="mt-4 flex justify-end items-center gap-4">
                          <span class="text-sm text-zinc-500 dark:text-zinc-400">Vista:</span>
                          <div class="flex items-center rounded-md bg-gray-100 dark:bg-zinc-700 p-1">
                              <button (click)="setExpenseViewMode('card')" class="p-1 rounded" [class.bg-white]="expenseViewMode() === 'card'" [class.dark:bg-zinc-600]="expenseViewMode() === 'card'">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                              </button>
                              <button (click)="setExpenseViewMode('list')" class="p-1 rounded" [class.bg-white]="expenseViewMode() === 'list'" [class.dark:bg-zinc-600]="expenseViewMode() === 'list'">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                              </button>
                          </div>
                      </div>
                  </div>

                  @if(paginatedExpenses().length > 0) {
                      <!-- Card View -->
                      @if (expenseViewMode() === 'card') {
                          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              @for (expense of paginatedExpenses(); track expense.id) {
                                  <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-lg p-5 flex flex-col justify-between"
                                    [class.item-enter-active]="newlyAddedItemIds().has(expense.id)"
                                    [class.item-leave-active]="expensesToDelete().has(expense.id)">
                                      <div>
                                          <div class="flex justify-between items-start mb-2">
                                              <h3 class="font-bold text-lg text-zinc-800 dark:text-white">{{ expense.description }}</h3>
                                              <span [class]="getPriorityClass(expense.priority)">{{ expense.priority }}</span>
                                          </div>
                                          <p class="text-2xl font-bold text-sky-600 dark:text-sky-400 mb-2">
                                              {{ expense.displayAmount | number:'1.2-2' }} {{ displayCurrency()?.symbol }}
                                          </p>
                                          <p class="text-sm text-zinc-500 dark:text-zinc-400 mb-1"><span class="font-semibold">Categoría:</span> {{ expense.category }}</p>
                                          @if (expense.status === 'COMPLETED') {
                                              <p class="text-sm text-zinc-500 dark:text-zinc-400"><span class="font-semibold">Pagado:</span> {{ expense.paidDate | date:'fullDate' }}</p>
                                          } @else {
                                              <p class="text-sm text-zinc-500 dark:text-zinc-400"><span class="font-semibold">Vence:</span> {{ expense.dueDate | date:'fullDate' }}</p>
                                          }
                                          @if (expense.isRecurring) {
                                            <div class="mt-2 flex items-center gap-1.5 text-xs text-sky-700 dark:text-sky-300">
                                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 12A8 8 0 1013 5.3v4.7l-4.5 4.5" /></svg>
                                              <span>Recurrente ({{ expense.recurrenceFrequency }})</span>
                                            </div>
                                          }
                                      </div>
                                      <div class="border-t dark:border-zinc-700 mt-4 pt-4 flex justify-end items-center gap-2">
                                          @if (expense.status === 'PENDING') {
                                              <button (click)="requestMarkAsCompleted(expense.id)" class="px-3 py-1 text-sm font-medium text-white bg-green-500 rounded-md hover:bg-green-600">Pagar</button>
                                          }
                                          <button (click)="openExpenseForm(expense)" class="p-2 text-zinc-500 hover:text-sky-600 dark:hover:text-sky-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                          <button (click)="requestDeleteExpense(expense.id)" class="p-2 text-zinc-500 hover:text-red-600 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 4.8.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                      </div>
                                  </div>
                              }
                          </div>
                      }
                      <!-- List View -->
                      @if (expenseViewMode() === 'list') {
                          <div class="bg-white dark:bg-zinc-800 shadow-lg rounded-lg overflow-hidden">
                              <div class="overflow-x-auto">
                                  <table class="w-full text-sm text-left text-zinc-500 dark:text-zinc-400">
                                      <thead class="text-xs text-zinc-700 uppercase bg-gray-50 dark:bg-zinc-700 dark:text-zinc-300">
                                          <tr>
                                              <th scope="col" class="px-6 py-3">Descripción</th>
                                              <th scope="col" class="px-6 py-3">Monto</th>
                                              <th scope="col" class="px-6 py-3 hidden md:table-cell">Categoría</th>
                                              <th scope="col" class="px-6 py-3 hidden lg:table-cell">Fecha</th>
                                              <th scope="col" class="px-6 py-3">Estado</th>
                                              <th scope="col" class="px-6 py-3 text-right">Acciones</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          @for (expense of paginatedExpenses(); track expense.id) {
                                              <tr class="bg-white border-b dark:bg-zinc-800 dark:border-zinc-700 hover:bg-gray-50 dark:hover:bg-zinc-600"
                                                [class.item-enter-active]="newlyAddedItemIds().has(expense.id)"
                                                [class.item-leave-active]="expensesToDelete().has(expense.id)">
                                                  <td class="px-6 py-4 font-medium text-zinc-900 whitespace-nowrap dark:text-white">{{ expense.description }}</td>
                                                  <td class="px-6 py-4 font-semibold">{{ expense.displayAmount | number:'1.2-2' }} {{ displayCurrency()?.symbol }}</td>
                                                  <td class="px-6 py-4 hidden md:table-cell">{{ expense.category }}</td>
                                                  <td class="px-6 py-4 hidden lg:table-cell">
                                                      {{ (expense.status === 'COMPLETED' ? expense.paidDate : expense.dueDate) | date:'mediumDate' }}
                                                  </td>
                                                  <td class="px-6 py-4">
                                                      <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                                        [class.bg-yellow-100]="expense.status === 'PENDING'" [class.text-yellow-800]="expense.status === 'PENDING'"
                                                        [class.dark:bg-yellow-900]="expense.status === 'PENDING'" [class.dark:text-yellow-200]="expense.status === 'PENDING'"
                                                        [class.bg-green-100]="expense.status === 'COMPLETED'" [class.text-green-800]="expense.status === 'COMPLETED'"
                                                        [class.dark:bg-green-900]="expense.status === 'COMPLETED'" [class.dark:text-green-200]="expense.status === 'COMPLETED'">
                                                        {{ expense.status === 'PENDING' ? 'Pendiente' : 'Pagado' }}
                                                      </span>
                                                  </td>
                                                  <td class="px-6 py-4 text-right">
                                                      <div class="flex items-center justify-end gap-1">
                                                          @if (expense.status === 'PENDING') {
                                                              <button (click)="requestMarkAsCompleted(expense.id)" class="p-2 text-green-500 hover:text-green-600 dark:hover:text-green-400" title="Marcar como Pagado"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></button>
                                                          }
                                                          <button (click)="openExpenseForm(expense)" class="p-2 text-zinc-500 hover:text-sky-600 dark:hover:text-sky-400" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                                          <button (click)="requestDeleteExpense(expense.id)" class="p-2 text-zinc-500 hover:text-red-600 dark:hover:text-red-400" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 4.8.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                                      </div>
                                                  </td>
                                              </tr>
                                          }
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      }
                      <!-- Pagination -->
                      <nav class="flex items-center justify-between border-t border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 px-4 py-3 sm:px-6 rounded-b-lg shadow-md mt-6">
                          <div class="hidden sm:block">
                              <p class="text-sm text-zinc-700 dark:text-zinc-300">{{ paginationSummary() }}</p>
                          </div>
                          <div class="flex flex-1 justify-between sm:justify-end">
                              <button (click)="previousPage()" [disabled]="currentPage() === 1" class="relative inline-flex items-center rounded-md bg-white dark:bg-zinc-700 px-3 py-2 text-sm font-semibold text-zinc-900 dark:text-zinc-200 ring-1 ring-inset ring-gray-300 dark:ring-zinc-600 hover:bg-gray-50 dark:hover:bg-zinc-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                  Anterior
                              </button>
                              <button (click)="nextPage()" [disabled]="currentPage() === totalPages()" class="relative ml-3 inline-flex items-center rounded-md bg-white dark:bg-zinc-700 px-3 py-2 text-sm font-semibold text-zinc-900 dark:text-zinc-200 ring-1 ring-inset ring-gray-300 dark:ring-zinc-600 hover:bg-gray-50 dark:hover:bg-zinc-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                  Siguiente
                              </button>
                          </div>
                      </nav>
                  } @else {
                    <div class="text-center py-20 bg-white dark:bg-zinc-800 rounded-lg shadow-md">
                      <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white">Sin Gastos</h3>
                      <p class="mt-1 text-sm text-gray-500 dark:text-zinc-400">No se encontraron gastos con los filtros actuales.</p>
                      <div class="mt-6">
                        <button (click)="openExpenseForm()" type="button" class="inline-flex items-center rounded-md bg-sky-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-600">
                          <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                          Añadir Nuevo Gasto
                        </button>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                 <div class="text-center py-20">
                  <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5-1.5-.545M3 7.5l3 1.5M3 7.5l-1.5-1.5M4.5 12l-3 1.5m15-3l3-1.5m-6-6l-1.5 1.5" /></svg>
                  <h2 class="mt-2 text-2xl font-semibold">Selecciona una casa</h2>
                  <p class="text-zinc-500 dark:text-zinc-400 mt-2">Por favor, selecciona una casa para ver sus gastos.</p>
                </div>
              }
            }
            @case ('suscripciones') {
               <div class="max-w-7xl mx-auto">
                  <div class="mb-6">
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Suscripciones Activas</h2>
                    <p class="text-zinc-500 dark:text-zinc-400 mt-1">Un resumen de todos tus gastos recurrentes.</p>
                  </div>
                  
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                      <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Gasto en Suscripciones (Este Año)</h3>
                      @if (hasSubscriptionSpendingData()) {
                        <app-line-chart [data]="subscriptionSpendingTrendData()" [currency]="displayCurrency()?.code ?? 'CUP'"></app-line-chart>
                      } @else {
                        <div class="flex items-center justify-center h-full min-h-[300px]">
                          <p class="text-zinc-500 dark:text-zinc-400">No hay datos de suscripciones pagadas este año.</p>
                        </div>
                      }
                    </div>
                    <div class="lg:col-span-1 bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Lista de Suscripciones</h3>
                        <div class="space-y-4 max-h-[32rem] overflow-y-auto pr-2">
                            @for(sub of activeSubscriptions(); track sub.id) {
                              <div class="p-4 rounded-md border border-gray-200 dark:border-zinc-700">
                                  <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-zinc-800 dark:text-zinc-200">{{ sub.description }}</p>
                                        <p class="text-sm text-zinc-500 dark:text-zinc-400">{{ getHouseName(sub.houseId) }}</p>
                                    </div>
                                    <p class="font-bold text-sky-600 dark:text-sky-400 text-right">
                                        {{ sub.displayAmount | number:'1.2-2' }} {{ displayCurrency()?.symbol }}
                                    </p>
                                  </div>
                                  <div class="mt-2 text-xs text-zinc-400 flex items-center justify-between">
                                    <span>Próximo pago: {{ sub.dueDate | date:'d MMMM yyyy' }}</span>
                                    <span>{{ sub.recurrenceFrequency }}</span>
                                  </div>
                              </div>
                            } @empty {
                              <div class="text-center py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691v4.992h-4.992m0 0-3.181-3.183a8.25 8.25 0 0 1 11.667 0l3.181 3.183" /></svg>
                                <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white">Sin suscripciones activas</h3>
                                <p class="mt-1 text-sm text-gray-500 dark:text-zinc-400">Añade un gasto recurrente.</p>
                              </div>
                            }
                        </div>
                    </div>
                  </div>
               </div>
            }
            @case ('notas') {
              @if (selectedHouse(); as house) {
                <div class="max-w-7xl mx-auto">
                  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Notas de {{ house.name }}</h2>
                    <button (click)="isNoteFormVisible.set(true)" class="mt-4 sm:mt-0 flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span>Añadir Nota</span>
                    </button>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    @for (note of notesForSelectedHouse(); track note.id) {
                      <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-lg p-5 flex flex-col border-t-4"
                           [class.border-amber-400]="note.isPinned"
                           [class.border-transparent]="!note.isPinned"
                           [class.item-enter-active]="newlyAddedItemIds().has(note.id)"
                           [class.item-leave-active]="notesToDelete().has(note.id)">
                        <div class="flex-grow">
                          <h3 class="font-bold text-lg text-zinc-800 dark:text-white mb-2">{{ note.title }}</h3>
                          <p class="text-sm text-zinc-600 dark:text-zinc-300 whitespace-pre-wrap mb-4">{{ note.content }}</p>
                        </div>
                        <div class="text-xs text-zinc-400 dark:text-zinc-500 mb-4">
                          <span>{{ note.author }} - {{ note.createdAt | date:'short' }}</span>
                        </div>
                        <div class="border-t dark:border-zinc-700 pt-3 flex justify-end items-center gap-2">
                          <button (click)="onTogglePinNote(note.id)" class="p-2 text-zinc-500" [class.text-amber-500]="note.isPinned" [class.hover:text-amber-500]="!note.isPinned" [class.hover:text-zinc-600]="note.isPinned" title="{{ note.isPinned ? 'Desfijar Nota' : 'Fijar Nota' }}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L13 7.414V15a1 1 0 11-2 0V7.414L7.707 10.707a1 1 0 01-1.414-1.414l6-6z" clip-rule="evenodd" transform="rotate(45 12 12)" /></svg>
                          </button>
                          <button (click)="requestDeleteNote(note.id)" class="p-2 text-zinc-500 hover:text-red-600 dark:hover:text-red-400" title="Eliminar Nota">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 4.8.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                          </button>
                        </div>
                      </div>
                    } @empty {
                      <div class="col-span-full text-center py-20 bg-white dark:bg-zinc-800 rounded-lg shadow-md">
                        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m6.75 12h-3m3 3h-3m3-10.5v5.25a2.25 2.25 0 0 0 2.25 2.25h2.25a2.25 2.25 0 0 0 2.25-2.25V10.5a2.25 2.25 0 0 0-2.25-2.25H15M5.25 12.75h3.75a2.25 2.25 0 0 1 2.25 2.25v5.25a2.25 2.25 0 0 1-2.25 2.25H5.25a2.25 2.25 0 0 1-2.25-2.25V15a2.25 2.25 0 0 1 2.25-2.25Z" /></svg>
                        <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white">Sin Notas</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-zinc-400">Añade tu primera nota para esta casa.</p>
                      </div>
                    }
                  </div>
                </div>
              } @else {
                <div class="text-center py-20">
                  <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5-1.5-.545M3 7.5l3 1.5M3 7.5l-1.5-1.5M4.5 12l-3 1.5m15-3l3-1.5m-6-6l-1.5 1.5" /></svg>
                  <h2 class="mt-2 text-2xl font-semibold">Selecciona una casa</h2>
                  <p class="text-zinc-500 dark:text-zinc-400 mt-2">Por favor, selecciona una casa para ver sus notas.</p>
                </div>
              }
            }
            @case ('metricas') {
               <div class="max-w-7xl mx-auto">
                  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Métricas de Gastos</h2>
                    <div class="mt-4 sm:mt-0">
                      <select (change)="onMetricsTimeFilterChange($event)" [value]="metricsTimeFilter()" class="w-full sm:w-48 text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                          <option value="6m">Últimos 6 Meses</option>
                          <option value="1y">Último Año</option>
                          <option value="all">Todo el Historial</option>
                      </select>
                    </div>
                  </div>

                  <div class="space-y-8">
                      <!-- Spending Trend & Category Breakdown -->
                      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                          <div class="lg:col-span-3 bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                              <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Tendencia de Gastos</h3>
                              @if (spendingTrendData().length > 1) {
                                  <app-line-chart [data]="spendingTrendData()" [currency]="displayCurrency()?.code ?? 'CUP'"></app-line-chart>
                              } @else {
                                  <div class="flex items-center justify-center h-full min-h-[300px]">
                                      <p class="text-zinc-500 dark:text-zinc-400">Datos insuficientes para mostrar la tendencia.</p>
                                  </div>
                              }
                          </div>
                          <div class="lg:col-span-2 bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                              <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Desglose por Categoría</h3>
                               @if (categoryBreakdownData().length > 0) {
                                  <app-donut-chart [data]="categoryBreakdownData()" [currency]="displayCurrency()?.code ?? 'CUP'"></app-donut-chart>
                              } @else {
                                  <div class="flex items-center justify-center h-full min-h-[300px]">
                                      <p class="text-zinc-500 dark:text-zinc-400">No hay datos de categorías para mostrar.</p>
                                  </div>
                              }
                          </div>
                      </div>
                      
                      @if (visibleHouses().length > 1) {
                          <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                              <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Gasto por Casa</h3>
                              @if (spendingByHouseData().length > 0) {
                                  <app-category-chart [data]="spendingByHouseData()" [currency]="displayCurrency()?.code ?? 'CUP'"></app-category-chart>
                              } @else {
                                  <div class="flex items-center justify-center h-full min-h-[300px]">
                                      <p class="text-zinc-500 dark:text-zinc-400">No hay gastos para comparar entre casas.</p>
                                  </div>
                              }
                          </div>
                      }

                      <!-- Monthly Breakdown -->
                      <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                          <h3 class="text-lg font-bold text-zinc-900 dark:text-white mb-4">Desglose Mensual</h3>
                          <div class="overflow-x-auto">
                              <table class="w-full text-sm text-left text-zinc-500 dark:text-zinc-400">
                                  <thead class="text-xs text-zinc-700 uppercase bg-gray-50 dark:bg-zinc-700 dark:text-zinc-300">
                                      <tr>
                                          <th scope="col" class="px-6 py-3">Mes</th>
                                          <th scope="col" class="px-6 py-3">Total Gastado</th>
                                          <th scope="col" class="px-6 py-3">Nº Gastos</th>
                                          <th scope="col" class="px-6 py-3">Categoría Principal</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      @for(month of monthlyBreakdownData(); track month.month) {
                                          <tr class="bg-white border-b dark:bg-zinc-800 dark:border-zinc-700 hover:bg-gray-50 dark:hover:bg-zinc-600">
                                              <td class="px-6 py-4 font-medium text-zinc-900 whitespace-nowrap dark:text-white">{{ month.month }}</td>
                                              <td class="px-6 py-4 font-semibold">{{ month.total | number:'1.2-2' }} {{ displayCurrency()?.symbol }}</td>
                                              <td class="px-6 py-4">{{ month.count }}</td>
                                              <td class="px-6 py-4">{{ month.topCategory }}</td>
                                          </tr>
                                      } @empty {
                                          <tr>
                                            <td colspan="4" class="text-center py-10">No hay datos de gastos para mostrar.</td>
                                          </tr>
                                      }
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
               </div>
            }
            @case ('casas') {
               @if (authService.isAdmin()) {
                <div class="max-w-7xl mx-auto">
                  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Gestionar Casas</h2>
                    <button (click)="openHouseForm()" class="mt-4 sm:mt-0 flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span>Añadir Casa</span>
                    </button>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    @for (house of housesWithStats(); track house.id) {
                      <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-lg overflow-hidden flex flex-col"
                        [class.item-enter-active]="newlyAddedItemIds().has(house.id)"
                        [class.item-leave-active]="housesToDelete().has(house.id)">
                          <img [ngSrc]="house.imageUrl" [alt]="house.name" width="400" height="200" priority class="w-full h-48 object-cover">
                          <div class="p-5 flex flex-col flex-grow">
                              <div class="flex-grow">
                                <h3 class="font-bold text-lg text-zinc-800 dark:text-white">{{ house.name }}</h3>
                                <p class="text-sm text-zinc-500 dark:text-zinc-400 mb-4">{{ house.address }}</p>
                                <div class="flex justify-between text-sm mb-1">
                                  <span class="text-zinc-600 dark:text-zinc-300">Gastos Pendientes:</span>
                                  <span class="font-semibold">{{ house.pendingCount }}</span>
                                </div>
                                 <div class="flex justify-between text-sm">
                                  <span class="text-zinc-600 dark:text-zinc-300">Monto Pendiente:</span>
                                  <span class="font-semibold">{{ formatCompactCurrency(house.pendingAmount) }}</span>
                                </div>
                              </div>
                              <div class="border-t dark:border-zinc-700 mt-4 pt-4 flex justify-end items-center gap-2">
                                  <button (click)="openHouseForm(house)" class="p-2 text-zinc-500 hover:text-sky-600 dark:hover:text-sky-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                  <button (click)="requestDeleteHouse(house.id)" class="p-2 text-zinc-500 hover:text-red-600 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 4.8.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                              </div>
                          </div>
                      </div>
                    } @empty {
                      <div class="col-span-full text-center py-20 bg-white dark:bg-zinc-800 rounded-lg shadow-md">
                        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5-1.5-.545M3 7.5l3 1.5M3 7.5l-1.5-1.5M4.5 12l-3 1.5m15-3l3-1.5m-6-6l-1.5 1.5" /></svg>
                        <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-white">Sin Casas</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-zinc-400">Añade tu primera casa para empezar a gestionar.</p>
                      </div>
                    }
                  </div>
                </div>
              }
            }
            @case ('usuarios') {
              @if (authService.isAdmin()) {
                <div class="max-w-7xl mx-auto">
                  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Gestionar Usuarios</h2>
                    <button (click)="openUserForm()" class="mt-4 sm:mt-0 flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span>Añadir Usuario</span>
                    </button>
                  </div>

                  <div class="bg-white dark:bg-zinc-800 shadow-lg rounded-lg overflow-hidden">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-zinc-500 dark:text-zinc-400">
                          <thead class="text-xs text-zinc-700 uppercase bg-gray-50 dark:bg-zinc-700 dark:text-zinc-300">
                            <tr>
                              <th scope="col" class="px-6 py-3">Usuario</th>
                              <th scope="col" class="px-6 py-3">Rol</th>
                              <th scope="col" class="px-6 py-3 hidden sm:table-cell">Casas Asignadas</th>
                              <th scope="col" class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (user of users(); track user.id) {
                              <tr class="bg-white border-b dark:bg-zinc-800 dark:border-zinc-700 hover:bg-gray-50 dark:hover:bg-zinc-600">
                                <td class="px-6 py-4 font-medium text-zinc-900 whitespace-nowrap dark:text-white">{{ user.username }}</td>
                                <td class="px-6 py-4">
                                  <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                    [class.bg-sky-100]="user.role === 'admin'" [class.text-sky-800]="user.role === 'admin'"
                                    [class.dark:bg-sky-900]="user.role === 'admin'" [class.dark:text-sky-200]="user.role === 'admin'"
                                    [class.bg-gray-100]="user.role === 'user'" [class.text-gray-800]="user.role === 'user'"
                                    [class.dark:bg-zinc-700]="user.role === 'user'" [class.dark:text-zinc-200]="user.role === 'user'">
                                    {{ user.role | titlecase }}
                                  </span>
                                </td>
                                <td class="px-6 py-4 hidden sm:table-cell">
                                  @if(user.role === 'admin') {
                                    <span class="text-zinc-400 italic">Todas</span>
                                  } @else {
                                    {{ getAssignedHouseNames(user) }}
                                  }
                                </td>
                                <td class="px-6 py-4 text-right">
                                   <div class="flex items-center justify-end gap-2">
                                      <button (click)="openUserForm(user)" class="p-2 text-zinc-500 hover:text-sky-600 dark:hover:text-sky-400 transition-colors" title="Editar Usuario">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                                      </button>
                                      @if(user.username !== 'admin') {
                                        <button (click)="requestDeleteUser(user.id)" class="p-2 text-zinc-500 hover:text-red-600 dark:hover:text-red-400 transition-colors" title="Eliminar Usuario">
                                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 4.8.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                        </button>
                                      }
                                    </div>
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                     </div>
                  </div>
                </div>
              }
            }
            @case ('configuracion') {
              @if (authService.isAdmin()) {
                <div class="max-w-4xl mx-auto space-y-12">
                  <div>
                    <h2 class="text-3xl font-bold text-zinc-900 dark:text-white">Configuración</h2>
                    <p class="text-zinc-500 dark:text-zinc-400 mt-1">Gestiona las opciones globales de la aplicación.</p>
                  </div>

                  <!-- Categories -->
                  <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                      <div class="flex justify-between items-center mb-4">
                          <h3 class="text-xl font-bold text-zinc-900 dark:text-white">Gestionar Categorías</h3>
                          <button (click)="openCategoryForm()" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Añadir
                          </button>
                      </div>
                      <ul class="space-y-2">
                        @for (cat of expenseCategories(); track cat) {
                          <li class="flex justify-between items-center p-3 rounded-md bg-gray-50 dark:bg-zinc-700/50"
                            [class.item-enter-active]="newlyAddedItemIds().has(cat)"
                            [class.item-leave-active]="categoriesToDelete().has(cat)">
                            <span class="font-medium">{{ cat }}</span>
                            <div class="flex items-center gap-2">
                               <button (click)="openCategoryForm(cat)" class="p-1 text-zinc-500 hover:text-sky-600 dark:hover:text-sky-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button>
                               <button (click)="requestDeleteCategory(cat)" class="p-1 text-zinc-500 hover:text-red-600 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                            </div>
                          </li>
                        }
                      </ul>
                  </div>
                  
                  <!-- Currencies -->
                  <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                      <div class="flex justify-between items-center mb-4">
                          <h3 class="text-xl font-bold text-zinc-900 dark:text-white">Gestionar Monedas</h3>
                          <button (click)="openCurrencyForm()" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Añadir
                          </button>
                      </div>
                      <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-zinc-500 dark:text-zinc-400">
                            <thead class="text-xs text-zinc-700 uppercase bg-gray-50 dark:bg-zinc-700 dark:text-zinc-300">
                                <tr>
                                    <th scope="col" class="px-4 py-2">Nombre</th>
                                    <th scope="col" class="px-4 py-2">Código</th>
                                    <th scope="col" class="px-4 py-2">Símbolo</th>
                                    <th scope="col" class="px-4 py-2">Tasa a CUP</th>
                                    <th scope="col" class="px-4 py-2"></th>
                                </tr>
                            </thead>
                            <tbody>
                              @for(curr of currencies(); track curr.code) {
                                <tr class="border-b dark:border-zinc-700"
                                  [class.item-enter-active]="newlyAddedItemIds().has(curr.code)"
                                  [class.item-leave-active]="currenciesToDelete().has(curr.code)">
                                  <td class="px-4 py-2 font-medium text-zinc-900 dark:text-white">{{ curr.name }}</td>
                                  <td class="px-4 py-2">{{ curr.code }}</td>
                                  <td class="px-4 py-2">{{ curr.symbol }}</td>
                                  <td class="px-4 py-2">{{ curr.rateToCUP }}</td>
                                  <td class="px-4 py-2 text-right">
                                    <div class="flex items-center justify-end">
                                      <button (click)="openCurrencyForm(curr)" class="p-1 text-zinc-500 hover:text-sky-600 dark:hover:text-sky-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button>
                                      @if (curr.code !== 'CUP') {
                                        <button (click)="requestDeleteCurrency(curr.code)" class="p-1 text-zinc-500 hover:text-red-600 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                      }
                                    </div>
                                  </td>
                                </tr>
                              }
                            </tbody>
                        </table>
                      </div>
                  </div>

                  <!-- Notifications -->
                  <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-lg">
                      <h3 class="text-xl font-bold text-zinc-900 dark:text-white mb-4">Configuración de Notificaciones</h3>
                      <div class="space-y-4">
                          <div class="flex items-center justify-between">
                              <label for="notifications-enabled" class="font-medium">Habilitar notificaciones de vencimiento</label>
                              <button (click)="toggleNotificationsEnabled()" type="button" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-600 focus:ring-offset-2" role="switch" [attr.aria-checked]="notificationsEnabled()">
                                <span class="sr-only">Habilitar notificaciones</span>
                                <span class="pointer-events-none absolute mx-auto h-5 w-11 rounded-full" [class]="notificationsEnabled() ? 'bg-sky-600' : 'bg-gray-200 dark:bg-zinc-600'"></span>
                                <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out" [class.translate-x-5]="notificationsEnabled()" [class.translate-x-0]="!notificationsEnabled()"></span>
                              </button>
                          </div>
                          @if(notificationsEnabled()) {
                            <div class="flex items-center justify-between">
                              <label for="notification-days" class="font-medium">Notificar con días de antelación</label>
                              <input type="number" id="notification-days" min="1" max="30" [value]="notificationDays()" (change)="updateNotificationDays($event)" class="w-24 text-base rounded-md border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 shadow-sm focus:border-sky-500 focus:ring-sky-500 px-3 py-2.5">
                            </div>
                          }
                      </div>
                  </div>

                </div>
              }
            }
            @default {
              <div class="text-center py-20">
                <h2 class="text-2xl font-semibold">Página no encontrada</h2>
                <p class="text-zinc-500 dark:text-zinc-400 mt-2">La vista seleccionada no existe.</p>
              </div>
            }
          }
        </main>
      </div>

      <!-- Modals & Toasts -->
      @if (isExpenseFormVisible()) {
        <app-expense-form 
          [categories]="expenseCategories()"
          [expense]="expenseToEdit()"
          (save)="onSaveExpense($event)" 
          (close)="isExpenseFormVisible.set(false)" />
      }

      @if (isNoteFormVisible()) {
        <app-note-form 
          (save)="onSaveNote($event)" 
          (close)="isNoteFormVisible.set(false)" />
      }

      @if (isHouseFormVisible()) {
        <app-house-form 
          [house]="houseToEdit()"
          [currencies]="currencies()"
          (save)="onSaveHouse($event)" 
          (close)="isHouseFormVisible.set(false)" />
      }
      
      @if (isUserFormVisible()) {
        <app-user-form
          [user]="userToEdit()"
          [houses]="dataService.houses()"
          (save)="onSaveUser($event)"
          (close)="isUserFormVisible.set(false)" />
      }

      @if (isCategoryFormVisible()) {
        <app-category-form 
          [category]="categoryToEdit()"
          (save)="onSaveCategory($event)" 
          (close)="isCategoryFormVisible.set(false)" />
      }

      @if (isCurrencyFormVisible()) {
        <app-currency-form 
          [currency]="currencyToEdit()"
          (save)="onSaveCurrency($event)" 
          (close)="isCurrencyFormVisible.set(false)" />
      }

      @if (isConfirmationDialogVisible()) {
        <app-confirmation-dialog 
          [title]="getConfirmationTitle()"
          [message]="getConfirmationMessage()"
          (confirm)="onConfirmDelete()" 
          (cancel)="onCancelDelete()" />
      }

      @if (isPayConfirmationVisible()) {
        <app-confirmation-dialog 
          title="Confirmar Pago"
          message="¿Estás seguro de que quieres marcar este gasto como pagado?"
          confirmButtonText="Confirmar"
          confirmButtonColor="green"
          iconType="success"
          (confirm)="onConfirmPay()" 
          (cancel)="onCancelPay()" />
      }

      <div class="fixed bottom-5 right-5 z-[100] w-full max-w-sm space-y-3">
          @for(notification of notifications(); track notification.id) {
              <app-notification-toast
                  class="item-enter-active"
                  [notification]="notification"
                  (dismiss)="dismissNotification($event)"
                  (executeAction)="handleNotificationAction($event)"
              />
          }
      </div>

    </div>
  }
}